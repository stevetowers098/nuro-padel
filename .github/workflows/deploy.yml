- name: Prepare VM for Deployment
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.VM_HOST }}
        username: Towers
        key: ${{ secrets.VM_SSH_KEY }}
        timeout: 120s
        command_timeout: 120s
        script: |
          set -e
          echo "ğŸ›‘ Stopping existing services first..."
          sudo systemctl stop padel-api yolo11-service yolov8-service mmpose-service yolo-nas-service combined-service 2>/dev/null || true
          
          echo "ğŸ“ Creating base directories..."
          sudo mkdir -p /opt/padel/{app,shared,yolo,mmpose,yolo-nas}
          sudo mkdir -p /opt/padel/app/{configs/body_2d_keypoint/rtmpose/coco,weights,scripts}
          sudo chown -R Towers:Towers /opt/padel
          
          echo "ğŸ—‘ï¸ Cleaning old code..."
          rm -rf /opt/padel/app/*
          
          echo "âœ… VM prepared for code transfer"

    - name: Transfer Code to VM (No GitHub Download on VM)
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VM_HOST }}
        username: Towers
        key: ${{ secrets.VM_SSH_KEY }}
        source: "./"
        target: "/opt/padel/app/"
        overwrite: true
        rm: true

    - name: Complete Deployment Setup
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.VM_HOST }}
        username: Towers
        key: ${{ secrets.VM_SSH_KEY }}
        timeout: 120s
        command_timeout: 120s
        script: |
          set -e
          echo "ğŸ“‹ Verifying deployed code:"
          ls -la /opt/padel/app/
          
          echo "ğŸ“„ Setting up requirements files..."
          cd /opt/padel
          if [ -d "app/requirements" ]; then
            cp -r app/requirements /opt/padel/
            echo "âœ… Requirements directory copied"
          else
            echo "âš ï¸ No requirements directory found"
          fi
          
          if [ -f "app/requirements.txt" ]; then
            cp app/requirements.txt /opt/padel/
            echo "âœ… Requirements.txt copied"
          else
            echo "âš ï¸ No requirements.txt found"
          fi
          
          echo "ğŸ¯ Code deployment complete!"
