name: Deploy NuroPadel to VM
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to VM
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        script: |
          # Stop all services
          echo "Stopping services..."
          sudo systemctl stop padel-api yolo11-service yolov8-service mmpose-service yolo-nas-service || true
          
          # Update code only (no model downloads)
          echo "Updating code..."
          cd /opt/padel
          
          # Backup current code (just in case)
          if [ -d "app" ]; then
            mv app app_backup_$(date +%Y%m%d_%H%M%S)
          fi
          
          # Clone repository and set up code
          git clone https://github.com/stevetowers098/nuro-padel.git temp
          mkdir -p app
          cp -r temp/app/* app/
          cp temp/requirements.txt .
          
          # Copy scripts if they exist
          if [ -d "temp/scripts" ]; then
            cp -r temp/scripts .
          fi
          
          rm -rf temp
          
          # Install dependencies in shared environment
          echo "Installing dependencies..."
          source shared/venv/bin/activate
          pip install -r requirements.txt
          
          # Set up dependency-grouped virtual environments
          echo "Setting up virtual environments..."
          
          # Modern PyTorch Environment (YOLO11, YOLOv8, Combined)
          if [ ! -d "/opt/padel/envs/modern-torch/venv" ]; then
            echo "Creating modern PyTorch environment..."
            mkdir -p /opt/padel/envs/modern-torch
            cd /opt/padel/envs/modern-torch
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip
            pip install torch==2.0.1 torchvision==0.15.2 --index-url https://download.pytorch.org/whl/cu118
            pip install ultralytics==8.0.196 opencv-python supervision fastapi uvicorn pydantic httpx numpy
            echo "✅ Modern PyTorch environment created"
            cd /opt/padel
          else
            echo "✅ Modern PyTorch environment already exists"
          fi
          
          # Legacy PyTorch Environment (MMPose)
          if [ ! -d "/opt/padel/envs/legacy-torch/venv" ]; then
            echo "Creating legacy PyTorch environment..."
            mkdir -p /opt/padel/envs/legacy-torch
            cd /opt/padel/envs/legacy-torch
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip
            pip install torch==1.12.1 torchvision==0.13.1 --index-url https://download.pytorch.org/whl/cu116
            pip install openmim
            mim install mmcv==1.7.2
            pip install mmpose fastapi uvicorn opencv-python pydantic httpx numpy
            echo "✅ Legacy PyTorch environment created"
            cd /opt/padel
          else
            echo "✅ Legacy PyTorch environment already exists"
          fi
          
          # Specialized Environment (YOLO-NAS)
          if [ ! -d "/opt/padel/envs/specialized/yolo-nas-venv" ]; then
            echo "Creating YOLO-NAS specialized environment..."
            mkdir -p /opt/padel/envs/specialized
            cd /opt/padel/envs/specialized
            python3 -m venv yolo-nas-venv
            source yolo-nas-venv/bin/activate
            pip install --upgrade pip
            pip install torch==1.13.1 torchvision==0.14.1 --index-url https://download.pytorch.org/whl/cu117
            pip install super-gradients fastapi uvicorn pydantic httpx numpy
            echo "✅ YOLO-NAS environment created"
            cd /opt/padel
          else
            echo "✅ YOLO-NAS environment already exists"
          fi
          
          # Create systemd service files with dependency-grouped environments
          echo "Creating service files..."
          
          # Combined Service (Modern PyTorch)
          sudo tee /etc/systemd/system/padel-api.service > /dev/null << 'EOL'
          [Unit]
          Description=NuroPadel Combined API
          After=network.target
          
          [Service]
          User=Towers
          Group=Towers
          WorkingDirectory=/opt/padel/app
          ExecStart=/opt/padel/envs/modern-torch/venv/bin/python -m app.main
          Restart=always
          RestartSec=10
          Environment="PYTHONPATH=/opt/padel"
          
          [Install]
          WantedBy=multi-user.target
          EOL
          
          # YOLO11 Service (Modern PyTorch)
          sudo tee /etc/systemd/system/yolo11-service.service > /dev/null << 'EOL'
          [Unit]
          Description=YOLO11 Pose Service
          After=network.target
          
          [Service]
          User=Towers
          Group=Towers
          WorkingDirectory=/opt/padel/app
          ExecStart=/opt/padel/envs/modern-torch/venv/bin/python -m app.models.yolo11_service
          Restart=always
          RestartSec=10
          Environment="PYTHONPATH=/opt/padel"
          
          [Install]
          WantedBy=multi-user.target
          EOL
          
          # YOLOv8 Service (Modern PyTorch)
          sudo tee /etc/systemd/system/yolov8-service.service > /dev/null << 'EOL'
          [Unit]
          Description=YOLOv8 Tracking Service
          After=network.target
          
          [Service]
          User=Towers
          Group=Towers
          WorkingDirectory=/opt/padel/app
          ExecStart=/opt/padel/envs/modern-torch/venv/bin/python -m app.models.yolov8_service
          Restart=always
          RestartSec=10
          Environment="PYTHONPATH=/opt/padel"
          
          [Install]
          WantedBy=multi-user.target
          EOL
          
          # MMPose Service (Legacy PyTorch)
          sudo tee /etc/systemd/system/mmpose-service.service > /dev/null << 'EOL'
          [Unit]
          Description=MMPose Biomechanics Service
          After=network.target
          
          [Service]
          User=Towers
          Group=Towers
          WorkingDirectory=/opt/padel/app
          ExecStart=/opt/padel/envs/legacy-torch/venv/bin/python -m app.models.mmpose_service
          Restart=always
          RestartSec=10
          Environment="PYTHONPATH=/opt/padel"
          
          [Install]
          WantedBy=multi-user.target
          EOL
          
          # YOLO-NAS Service (Specialized)
          sudo tee /etc/systemd/system/yolo-nas-service.service > /dev/null << 'EOL'
          [Unit]
          Description=YOLO-NAS Pose Service
          After=network.target
          
          [Service]
          User=Towers
          Group=Towers
          WorkingDirectory=/opt/padel/app
          ExecStart=/opt/padel/envs/specialized/yolo-nas-venv/bin/python -m app.models.yolo_nas_service
          Restart=always
          RestartSec=10
          Environment="PYTHONPATH=/opt/padel"
          
          [Install]
          WantedBy=multi-user.target
          EOL
          
          # Reload systemd and start services
          echo "Starting services..."
          sudo systemctl daemon-reload
          sudo systemctl enable padel-api yolo11-service yolov8-service mmpose-service yolo-nas-service
          sudo systemctl start padel-api yolo11-service yolov8-service mmpose-service yolo-nas-service
          
          # Wait for services to start
          sleep 15
          
          # Verify services
          echo "Verifying services..."
          for service in padel-api yolo11-service yolov8-service mmpose-service yolo-nas-service; do
            status=$(systemctl is-active $service)
            echo "$service: $status"
            if [ "$status" != "active" ]; then
              echo "WARNING: $service failed to start properly"
              echo "Last 10 log lines:"
              sudo journalctl -u $service -n 10 --no-pager
            fi
          done
          
          # Test health endpoints
          echo "Testing health endpoints..."
          sleep 5
          for port in 8000 8001 8002 8003 8004; do
            if curl -s -f http://localhost:$port/healthz > /dev/null; then
              echo "✅ Port $port: healthy"
            else
              echo "❌ Port $port: not responding"
            fi
          done
          
          echo "Deployment completed"
