- name: Deploy Application Code
  uses: appleboy/ssh-action@v0.1.7
  with:
    host: ${{ secrets.VM_HOST }}
    username: Towers
    key: ${{ secrets.VM_SSH_KEY }}
    timeout: 300s          # Reduced timeout
    command_timeout: 300s  # Reduced timeout
    script: |
      set -e
      echo "ğŸ›‘ Stopping existing services first..."
      sudo systemctl stop padel-api yolo11-service yolov8-service mmpose-service yolo-nas-service combined-service 2>/dev/null || true
      
      echo "ğŸ“ Creating base directories..."
      sudo mkdir -p /opt/padel/{app,shared,yolo,mmpose,yolo-nas}
      sudo mkdir -p /opt/padel/app/{configs/body_2d_keypoint/rtmpose/coco,weights,scripts}
      sudo chown -R Towers:Towers /opt/padel
      
      echo "ğŸ“¦ Deploying application code..."
      cd /opt/padel
      rm -rf app
      
      echo "ğŸ“¥ Downloading latest code (method 1: git clone with timeout)..."
      if timeout 60 git clone --depth 1 --single-branch --quiet https://github.com/stevetowers098/nuro-padel.git app; then
        echo "âœ… Git clone successful"
      else
        echo "âš ï¸ Git clone failed, trying archive download..."
        rm -rf app
        wget -q --timeout=30 -O latest.zip https://github.com/stevetowers098/nuro-padel/archive/refs/heads/main.zip
        unzip -q latest.zip
        mv nuro-padel-main app
        rm latest.zip
        echo "âœ… Archive download successful"
      fi
      
      echo "ğŸ“‹ Code deployed successfully:"
      ls -la app/
      
      # Copy requirements files (hardcoded, never change)
      cp -r app/requirements /opt/padel/ 2>/dev/null || echo "âš ï¸ No requirements directory found"
      cp app/requirements.txt /opt/padel/ 2>/dev/null || echo "âš ï¸ No requirements.txt found"
      
      echo "ğŸ¯ Deploy step complete!"
