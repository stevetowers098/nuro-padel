name: ⚡ Fast Development Deploy

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Which service to rebuild (or "all")'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - mmpose
        - yolo-combined
        - yolo-nas

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: nuro-padel

jobs:
  fast-dev-deploy:
    name: ⚡ Fast Development Deploy to VM
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH key
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.VM_SSH_KEY }}
        
    - name: Add VM to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts
        
    - name: Fast Development Deploy
      run: |
        ssh ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'
          cd ${{ secrets.VM_PATH }}
          
          echo "⚡ Starting fast development deployment..."
          echo "Service: ${{ github.event.inputs.service }}"
          
          # Make script executable
          chmod +x dev-fast.sh
          
          # Run fast development deployment
          ./dev-fast.sh
          
          echo "✅ Fast development deployment complete!"
        EOF
        
    - name: Verify Deployment
      run: |
        ssh ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'
          echo "🔍 Checking service health..."
          
          # Test health endpoints
          curl -f http://localhost:8001/healthz && echo "✅ YOLO Combined healthy"
          curl -f http://localhost:8003/healthz && echo "✅ MMPose healthy"  
          curl -f http://localhost:8004/healthz && echo "✅ YOLO-NAS healthy"
          curl -f http://localhost:8080/healthz && echo "✅ Nginx healthy"
          
          echo "🎉 All services deployed and healthy!"
        EOF