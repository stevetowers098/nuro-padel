name: Deploy NuroPadel to VM
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to VM
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        script: |
          # Stop main service
          sudo systemctl stop padel-api || true
          
          # Update code
          cd /opt/padel/app
          rm -rf *
          
          # Clone repository
          git clone https://github.com/stevetowers098/nuro-padel.git temp
          cp -r temp/app/* .
          cp temp/requirements.txt ../
          rm -rf temp
          
          # Install dependencies in shared environment
          /opt/padel/shared/venv/bin/pip install -r ../requirements.txt
          
          # Download YOLO models
          mkdir -p models
          cd /opt/padel/yolo && source venv/bin/activate
          python -c "from ultralytics import YOLO; YOLO('yolo11n-pose.pt').save('/opt/padel/app/models/yolo11n-pose.pt')"
          python -c "from ultralytics import YOLO; YOLO('yolo11n.pt').save('/opt/padel/app/models/yolo11n.pt')"
          python -c "from ultralytics import YOLO; YOLO('yolov8n.pt').save('/opt/padel/app/models/yolov8n.pt')"
          
          # Create systemd service if missing
          if [ ! -f /etc/systemd/system/padel-api.service ]; then
            sudo tee /etc/systemd/system/padel-api.service << 'EOF'
          [Unit]
          Description=Padel AI API
          After=network.target

          [Service]
          Type=simple
          User=Towers
          WorkingDirectory=/opt/padel/app
          Environment=PATH=/opt/padel/shared/venv/bin
          ExecStart=/opt/padel/shared/venv/bin/python main.py
          Restart=always

          [Install]
          WantedBy=multi-user.target
          EOF
          fi
          
          sudo systemctl daemon-reload
          sudo systemctl enable padel-api
          sudo systemctl start padel-api
