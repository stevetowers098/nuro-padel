name: ðŸš€ CI & Deploy to VM

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual triggering

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: stevetowers098/nuro-padel

jobs:
  build-and-push:
    name: ðŸ”¨ Build & Push Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      build-time: ${{ steps.build-info.outputs.build-time }}
      image-tags: ${{ steps.build-info.outputs.image-tags }}
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ› ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ“Š Build Info
        id: build-info
        run: |
          echo "build-time=$(date -u +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          echo "image-tags=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "ðŸ” Building images with tag: ${{ github.sha }}"

      - name: ðŸ¤– Build and push yolo-combined
        uses: docker/build-push-action@v5
        with:
          context: ./services/yolo-combined
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/yolo-combined:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/yolo-combined:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ðŸ¦´ Build and push mmpose
        uses: docker/build-push-action@v5
        with:
          context: ./services/mmpose
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/mmpose:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/mmpose:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ðŸŽ¯ Build and push yolo-nas
        uses: docker/build-push-action@v5
        with:
          context: ./services/yolo-nas
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/yolo-nas:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/yolo-nas:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: âœ… Build Summary
        run: |
          echo "ðŸŽ‰ Successfully built and pushed all Docker images!"
          echo "ðŸ“¦ Images pushed to: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          echo "ðŸ·ï¸ Tags: latest, ${{ github.sha }}"
          echo "â° Build completed at: $(date -u)"

  deploy-to-vm:
    name: ðŸš€ Deploy to Production VM
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“‹ Pre-deployment Info
        run: |
          echo "ðŸŽ¯ Deploying to VM: ${{ secrets.VM_IP }}"
          echo "ðŸ“¦ Using images from build: ${{ needs.build-and-push.outputs.image-tags }}"
          echo "â° Build time: ${{ needs.build-and-push.outputs.build-time }}"
          echo "ðŸ”„ Starting SSH deployment..."

      - name: ðŸ”— Deploy to VM via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_IP }}
          username: Towers
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            echo "ðŸš€ Starting deployment on VM..."
            echo "ðŸ“ VM: $(hostname) - $(whoami)@$(hostname -I | awk '{print $1}')"
            echo "â° Deployment started at: $(date)"
            echo ""
            
            # Navigate to project directory
            echo "ðŸ“‚ Navigating to project directory..."
            cd /opt/padel-docker || {
              echo "âŒ Error: Could not navigate to /opt/padel-docker"
              exit 1
            }
            
            echo "âœ… Current directory: $(pwd)"
            echo "ðŸ“‹ Directory contents:"
            ls -la
            echo ""
            
            # Make deploy script executable
            echo "ðŸ”§ Making deploy script executable..."
            chmod +x scripts/deploy.sh
            
            # Run the deployment
            echo "ðŸš€ Running deployment script..."
            echo "================================================"
            ./scripts/deploy.sh --vm
            echo "================================================"
            
            # Check if deployment was successful
            if [ $? -eq 0 ]; then
              echo "âœ… Deployment script completed successfully!"
            else
              echo "âŒ Deployment script failed!"
              exit 1
            fi

  health-check:
    name: ðŸ¥ Health Check & Validation
    needs: [build-and-push, deploy-to-vm]
    runs-on: ubuntu-latest
    steps:
      - name: â³ Wait for services to stabilize
        run: |
          echo "â³ Waiting 90 seconds for services to fully start and stabilize..."
          echo "ðŸ”„ This ensures all containers are ready before health checks"
          sleep 90
          echo "âœ… Wait period completed"

      - name: ðŸ¥ Comprehensive Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_IP }}
          username: Towers
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            echo "ðŸ¥ Starting comprehensive health checks..."
            echo "â° Health check started at: $(date)"
            echo ""
            
            cd /opt/padel-docker
            
            # Check Docker containers status
            echo "ðŸ³ Docker Container Status:"
            echo "================================"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            echo ""
            
            # Check Docker Compose services
            echo "ðŸ“‹ Docker Compose Service Status:"
            echo "======================================"
            cd deployment
            docker-compose ps
            echo ""
            
            # Health check function
            check_service_health() {
              local service_name=$1
              local port=$2
              local endpoint="http://localhost:${port}/healthz"
              
              echo "ðŸ” Testing ${service_name} on port ${port}..."
              
              # Try health check with timeout
              if timeout 30 curl -f -s "$endpoint" > /dev/null 2>&1; then
                echo "âœ… ${service_name} health check PASSED"
                
                # Get additional service info
                local response=$(curl -s "$endpoint" 2>/dev/null || echo "No response")
                echo "ðŸ“Š ${service_name} response: $response"
                return 0
              else
                echo "âŒ ${service_name} health check FAILED"
                echo "ðŸ” Checking ${service_name} logs..."
                docker-compose logs --tail 10 "$service_name" || echo "Could not retrieve logs"
                return 1
              fi
            }
            
            # Test all services
            echo "ðŸ§ª Testing individual services..."
            echo "================================="
            
            health_check_failed=false
            
            # Test YOLO Combined
            if ! check_service_health "yolo-combined" 8001; then
              health_check_failed=true
            fi
            echo ""
            
            # Test MMPose
            if ! check_service_health "mmpose" 8003; then
              health_check_failed=true
            fi
            echo ""
            
            # Test YOLO-NAS
            if ! check_service_health "yolo-nas" 8004; then
              health_check_failed=true
            fi
            echo ""
            
            # Test Load Balancer
            echo "ðŸ” Testing load balancer on port 8080..."
            if timeout 30 curl -f -s "http://localhost:8080" > /dev/null 2>&1; then
              echo "âœ… Load balancer health check PASSED"
            else
              echo "âŒ Load balancer health check FAILED"
              health_check_failed=true
            fi
            echo ""
            
            # Final health check summary
            echo "ðŸ“Š HEALTH CHECK SUMMARY"
            echo "======================="
            if [ "$health_check_failed" = true ]; then
              echo "âŒ Some services failed health checks!"
              echo "ðŸ” Check the logs above for details"
              exit 1
            else
              echo "âœ… ALL SERVICES ARE HEALTHY!"
              echo "ðŸŽ‰ Deployment completed successfully!"
            fi

  integration-tests:
    name: ðŸ§ª Integration Tests
    needs: [build-and-push, deploy-to-vm, health-check]
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ§ª Run Integration Tests
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_IP }}
          username: Towers
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            echo "ðŸ§ª Starting integration tests..."
            echo "â° Tests started at: $(date)"
            echo ""
            
            cd /opt/padel-docker
            
            # Test service endpoints with sample data
            echo "ðŸŽ¯ Testing service endpoints..."
            echo "=============================="
            
            # Function to test service endpoint
            test_service_endpoint() {
              local service_name=$1
              local port=$2
              local test_description=$3
              
              echo "ðŸ” Testing ${service_name}: ${test_description}"
              
              # Test health endpoint
              local health_url="http://localhost:${port}/healthz"
              if curl -f -s "$health_url" > /dev/null; then
                echo "âœ… ${service_name} health endpoint working"
              else
                echo "âŒ ${service_name} health endpoint failed"
                return 1
              fi
              
              # Test if service responds to basic requests
              local info_url="http://localhost:${port}/"
              if curl -f -s -o /dev/null "$info_url"; then
                echo "âœ… ${service_name} main endpoint responsive"
              else
                echo "âš ï¸  ${service_name} main endpoint check inconclusive"
              fi
              
              echo ""
            }
            
            # Test all services
            test_service_endpoint "yolo-combined" 8001 "YOLO object detection service"
            test_service_endpoint "mmpose" 8003 "MMPose pose estimation service" 
            test_service_endpoint "yolo-nas" 8004 "YOLO-NAS advanced detection service"
            
            # Test load balancer
            echo "ðŸ” Testing load balancer functionality..."
            if curl -f -s "http://localhost:8080" > /dev/null; then
              echo "âœ… Load balancer is distributing traffic"
            else
              echo "âŒ Load balancer test failed"
              exit 1
            fi
            echo ""
            
            # System resource check
            echo "ðŸ“Š System Resource Usage:"
            echo "========================"
            echo "ðŸ’¾ Memory Usage:"
            free -h
            echo ""
            echo "ðŸ’½ Disk Usage:"
            df -h | head -5
            echo ""
            echo "ðŸ–¥ï¸  CPU Usage:"
            top -bn1 | head -5
            echo ""
            
            # Docker resource usage
            echo "ðŸ³ Docker Resource Usage:"
            echo "========================="
            docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"
            echo ""
            
            echo "ðŸŽ‰ All integration tests completed successfully!"
            echo "âœ… Deployment is fully operational!"

  deployment-summary:
    name: ðŸ“ˆ Deployment Summary
    needs: [build-and-push, deploy-to-vm, health-check, integration-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ðŸ“ˆ Generate Deployment Summary
        run: |
          echo "# ðŸš€ Deployment Summary Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Deployment Status" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.build-and-push.result }}" = "success" ] && \
             [ "${{ needs.deploy-to-vm.result }}" = "success" ] && \
             [ "${{ needs.health-check.result }}" = "success" ] && \
             [ "${{ needs.integration-tests.result }}" = "success" ]; then
            echo "âœ… **DEPLOYMENT SUCCESSFUL** - All services are healthy and operational!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **DEPLOYMENT FAILED** - Check individual job logs for details" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ” Job Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”¨ Build & Push | ${{ needs.build-and-push.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ Deploy to VM | ${{ needs.deploy-to-vm.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ¥ Health Check | ${{ needs.health-check.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Integration Tests | ${{ needs.integration-tests.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”— Service URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **YOLO Combined**: http://${{ secrets.VM_IP }}:8001/healthz" >> $GITHUB_STEP_SUMMARY
          echo "- **MMPose**: http://${{ secrets.VM_IP }}:8003/healthz" >> $GITHUB_STEP_SUMMARY
          echo "- **YOLO-NAS**: http://${{ secrets.VM_IP }}:8004/healthz" >> $GITHUB_STEP_SUMMARY
          echo "- **Load Balancer**: http://${{ secrets.VM_IP }}:8080/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Images Built" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: ghcr.io/stevetowers098/nuro-padel" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time**: ${{ needs.build-and-push.outputs.build-time }}" >> $GITHUB_STEP_SUMMARY
          
          echo ""
          echo "ðŸŽ‰ Deployment workflow completed!"
          echo "Check the summary above for detailed results."