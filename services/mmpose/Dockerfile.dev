# MMPose Development Dockerfile - FAST builds for code changes
# Uses pre-built base image with heavy dependencies already installed

# Use the base image with all heavy dependencies (built once)
FROM ghcr.io/stevetowers098/nuro-padel/base:latest

# Set working directory
WORKDIR /app

# Copy and install ONLY the light requirements (fast changes)
COPY requirements.txt .
RUN echo "ğŸš€ Installing light requirements (fast)..." && \
    pip install --no-cache-dir -r requirements.txt --verbose && \
    echo "âœ… Light requirements installed in ~30 seconds!"

# Create weights directory
RUN mkdir -p /app/weights

# Copy application code (this layer rebuilds quickly when you change code)
COPY . .

# Set proper permissions
RUN chmod +x /app/main.py

# Quick verification (no heavy imports needed)
RUN echo "ğŸ” Quick verification..." && \
    python -c "import fastapi; print('âœ… FastAPI ready')" && \
    python -c "import mmpose; print('âœ… MMPose ready from base image')" && \
    echo "ğŸ“Š Development build complete in ~1-2 minutes!"

# Create non-root user for security
RUN groupadd -r appuser && useradd -r -g appuser appuser
RUN chown -R appuser:appuser /app
USER appuser

# Health check
HEALTHCHECK --interval=30s --timeout=30s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8003/healthz || exit 1

# Expose port
EXPOSE 8003

# Start command
CMD ["python", "main.py"]